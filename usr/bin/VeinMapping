#!/usr/bin/python
from PIL import Image
import imagehash
import MySQLdb
import time
import picamera
import re
import sys
def table(userBranch):
    if userBranch == 1:
        tabName = "CE"
    elif userBranch = 2:
        tabName = "ME"
    elif userBranch = 3:
        tabName = "EE"
    elif userBranch = 4:
        tabName = "ECE"
    elif userBranch = 5:
        tabName = "CSE"
    else
        tabName = "EnI"
    return tabName
def HammingDistance(imHash1,imHash2):
    dst = 0
    for x,y in zip(imHash1,imHash2):
        if x!=y:
            dst+=1
    return dst
def expCheck(userSchNo):
    r = re.compile(r'\d{2}\-\d{1}\-\d{1}\-\d{2,3}')
    if r.match(userSchNo) is not None:
        return 0
    else:
        return 1
print "Welcome User!"
user = int(raw_input("Identify Yourself - New User Press 1 and Existing User Press 0 : "))
db = MySQLdb.connect("localhost","studentUser","studentPass","studentDB")
if user==1:
    userName = raw_input("Enter your full name : ")
    userSchNo = raw_input("Enter your scholar no. (xx-x-x-xxx format) : ")
    if expCheck(userSchNo):
        print "Wrong format of Scholar Number!!"
        sys.exit()
    joinYear = 2000+int(userSchNo.split('-')[0])
    userBranch = int(userSchNo.split('-')[2])
    userRoll = int(userSchNo.split('-')[3])
    raw_input("Place your hand on the camera and press Enter to continue : ")
    camera = picamera.PiCamera()
    camera.resolution(1024,720)
    sleep(2)
    camera.capture('VeinMap.jpg')
    print "Please remove your hand from the camera."
    im = Image.open('VeinMap.jpg')
    imHash = str(imagehash.dhash(im))
    tabName = table(userBranch)
    ptr = db.cursor()
    sql = "INSERT INTO %s VALUES(%s,%s,%s)"%(userSchNo,userName,imHash)
    try:
        ptr.execute(sql)
        db.commit()
    except:
        db.rollback()
    print "Thank you for Registering!"
    db.close()
    sys.exit()
elif user==0:
    userSchNo = raw_input("Enter your Scholar No. (xx-x-x-xxx format) : ")
    if expCheck(userSchNo):
        print "Wrong format of Scholar Number!!"
        sys.exit()
    raw_input("Place your hand on the camera and press Enter to continue : ")
    camera = picamera.PiCamera()
    camera.resolution(1024,720)
    sleep(2)
    camera.capture('VeinMap.jpg')
    print "Please remove your hand from the camera."
    im = Image.open('VeinMap.jpg')
    imHashVer = str(imagehash.dhash(im))
    tabName = table(int(userSchNo.split('-')[2]))
    sql = "SELECT * FROM %s WHERE userSchNo = %s"%(tabName,userSchNo)
    ptr = db.cursor()
    userSchNo,username,imHash = zip(*ptr.fetchall())
    if HammingDistance(imHashVer,imHash)<=3 :
        print " Welcome %s"%(userName)
    else:
        print "Unauthorized!!"
    db.close()
    sys.exit()
else:
    print "Wrong Input!!"
    sys.exit()
        
    
    
    
    
    
    
    
